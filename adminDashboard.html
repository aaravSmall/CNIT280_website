<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<style>
body { font-family: Arial,sans-serif; margin:0; background:#f4f4f9; color:#333; }
header { background:#3b5d5b; color:white; padding:15px; text-align:center; }
nav { display:flex; justify-content:center; background:#ece0d7; padding:10px; gap:12px; }
nav a { text-decoration:none; font-weight:bold; color:#31333e; }
nav a:hover { text-decoration:underline; }
.container { max-width:1100px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:10px; text-align:left; }
th { background:#3b5d5b; color:white; }
button { background:#3b5d5b; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
button:hover { background:#2d4443; }
.metrics { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:12px; }
.metric { background:#f7f7f7; padding:10px; border-radius:8px; flex:1 1 180px; text-align:center; }
.popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.popup-content { background:white; padding:20px; border-radius:10px; max-width:520px; width:92%; position:relative; }
.close-btn { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#333; }
label{display:block;margin-top:8px}
input, select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
#reportsContainer { background:#f7f7f7; padding:12px; border-radius:8px; margin-top:18px; }
</style>
<!-- Graphs for 1002 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header><h1>Admin Dashboard</h1></header>
<nav>
  <a href="homePage.html">Home</a>
  <a href="calendar.html">Calendar</a>
  <a href="#" onclick="logout()">Logout</a>
</nav>

<div class="container">
  <!-- KPI DASHBOARD (1001) -->
  <h2>Leadership KPI Dashboard</h2>
  <div class="metrics" id="summaryMetrics">
    <div class="metric"><strong id="totalEvents">0</strong><div>Total Events</div></div>
    <div class="metric"><strong id="completedEvents">0</strong><div>Completed Events</div></div>
    <div class="metric"><strong id="pendingEvents">0</strong><div>Pending Events</div></div>
    <div class="metric"><strong id="avgAttendance">0</strong><div>Avg Attendance</div></div>
    <div class="metric"><strong id="avgRating">0</strong><div>Avg Rating</div></div>
    <div class="metric"><strong id="totalRevenue">0</strong><div>Est. Revenue</div></div>
    <div class="metric"><strong id="paidInvoices">0</strong><div>Paid Invoices</div></div>
    <div class="metric"><strong id="pendingInvoices">0</strong><div>Pending Invoices</div></div>
  </div>

  <!-- UTILIZATION & PEAK TIME (801, 802 extended) -->
  <h3>Utilization & Peak Time Reports</h3>
  <div id="reportsContainer">
    <p><strong>Utilization Rate:</strong> <span id="utilizationRate">0%</span></p>
    <p><strong>Peak Booking Day:</strong> <span id="peakDay">N/A</span></p>
  </div>

  <!-- GRAPHICAL METRICS (1002) -->
  <h3 style="margin-top:20px;">Graphical Metrics</h3>
  <canvas id="eventsPerTypeChart" style="max-width:600px; margin-top:10px;"></canvas>

  <!-- ACTIVE ORDERS -->
  <h2 style="margin-top:30px;">Active Orders</h2>
  <table>
    <thead>
      <tr><th>Customer Name</th><th>Order Type</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="adminOrdersBody"></tbody>
  </table>
  <p id="noOrders" style="text-align:center; margin-top:10px; display:none;">No events yet.</p>

  <!-- HISTORICAL ORDERS (702) -->
  <h2>Historical Orders</h2>
  <table>
    <thead>
      <tr><th>Customer Name</th><th>Order Type</th><th>Status</th><th>Attendance</th><th>Rating</th></tr>
    </thead>
    <tbody id="historicalOrdersBody"></tbody>
  </table>

  <!-- INVOICES (501, 502) -->
  <h2>Invoices & Payments</h2>
  <table>
    <thead>
      <tr><th>Invoice #</th><th>Customer</th><th>Order Type</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="invoiceBody"></tbody>
  </table>
</div>

<!-- POPUP -->
<div class="popup" id="orderPopup">
  <div class="popup-content">
    <span class="close-btn" onclick="closePopup()">&times;</span>
    <h2>Event Details & Management</h2>
    <div id="eventDetailSummary"></div>

    <label for="admin-date">Change Date (Nov 1â€“30, 2025)</label>
    <input type="date" id="admin-date" min="2025-11-01" max="2025-11-30">

    <label for="admin-staff">Assign Staff</label>
    <select id="admin-staff"><option value="">- none -</option><option value="staff1">staff1</option></select>

    <label for="admin-att">Attendance</label>
    <input type="number" id="admin-att" min="0">

    <label for="admin-rate">Rating (1-5)</label>
    <input type="number" id="admin-rate" min="1" max="5">

    <div style="text-align:right; margin-top:10px;">
      <button onclick="saveAdminEdits()">Save</button>
      <button onclick="markCompleteAdmin()" style="margin-left:8px;">Mark Complete</button>
      <button onclick="deleteEventAdmin()" style="margin-left:8px; background:#c0392b;">Delete</button>
    </div>
  </div>
</div>

<script>
let currentUser = null;
try { currentUser = JSON.parse(localStorage.getItem("currentUser")); } catch(e){currentUser=null;}
if(!currentUser || currentUser.role!=='admin'){ alert('Access denied. Only admin.'); window.location.href='login.html'; }

function logout(){ localStorage.removeItem('currentUser'); window.location.href='login.html'; }

function loadEvents(){ return JSON.parse(localStorage.getItem('events')||'[]'); }
function saveEvents(arr){ localStorage.setItem('events', JSON.stringify(arr)); }

function loadInvoices(){ return JSON.parse(localStorage.getItem('invoices')||'[]'); }
function saveInvoices(arr){ localStorage.setItem('invoices', JSON.stringify(arr)); }

function renderSummary(){
  const events = loadEvents();
  const invoices = loadInvoices();
  const total = events.length;
  const completed = events.filter(e=>e.completed).length;
  const pending = total - completed;
  document.getElementById('totalEvents').textContent = total;
  document.getElementById('completedEvents').textContent = completed;
  document.getElementById('pendingEvents').textContent = pending;

  const attArr = events.filter(e=>e.attendance!=null).map(e=>e.attendance);
  document.getElementById('avgAttendance').textContent = attArr.length ? Math.round(attArr.reduce((a,b)=>a+b,0)/attArr.length) : 0;

  const rArr = events.filter(e=>e.rating>0).map(e=>e.rating);
  document.getElementById('avgRating').textContent = rArr.length ? (rArr.reduce((a,b)=>a+b,0)/rArr.length).toFixed(1) : 0;

  const revenue = events.reduce((sum,e)=> sum + ((e.attendance||0)*10 + 50), 0);
  document.getElementById('totalRevenue').textContent = '$' + revenue;

  const paid = invoices.filter(i=>i.status==='Paid').length;
  const pendInv = invoices.filter(i=>i.status==='Pending').length;
  document.getElementById('paidInvoices').textContent = paid;
  document.getElementById('pendingInvoices').textContent = pendInv;
}

function renderReports(){
  const events = loadEvents();
  const totalDays = 30;
  const bookedDays = new Set(events.map(e=>e.date)).size;
  const utilization = Math.round((bookedDays / totalDays) * 100);
  document.getElementById('utilizationRate').textContent = utilization + '%';

  const dayCount = {};
  events.forEach(e=> {
    if(!e.date) return;
    dayCount[e.date] = (dayCount[e.date]||0) + 1;
  });
  const entries = Object.entries(dayCount);
  let peak = null;
  if(entries.length){
    entries.sort((a,b)=>b[1]-a[1]);
    peak = entries[0];
  }
  document.getElementById('peakDay').textContent = peak ? `${peak[0]} (${peak[1]} bookings)` : 'N/A';
}

let eventsChart = null;
function renderCharts(){
  const events = loadEvents();
  const typeCounts = {};
  events.forEach(e=>{
    const t = e.orderInfo?.type || e.type || 'Other';
    typeCounts[t] = (typeCounts[t]||0) + 1;
  });
  const labels = Object.keys(typeCounts);
  const data = Object.values(typeCounts);
  const ctx = document.getElementById('eventsPerTypeChart').getContext('2d');
  if(eventsChart) eventsChart.destroy();
  eventsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Events per Type',
        data,
      }]
    },
    options: {
      responsive:true,
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

function loadTable(){
  const events = loadEvents();
  const tbody = document.getElementById('adminOrdersBody'); 
  const histBody = document.getElementById('historicalOrdersBody');
  tbody.innerHTML=''; histBody.innerHTML='';
  document.getElementById('noOrders').style.display = events.length ? 'none':'block';

  events.forEach(ev=>{
    if(ev.completed){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${ev.title}</td><td>${ev.orderInfo?.type||ev.type||'-'}</td><td>Complete</td><td>${ev.attendance||0}</td><td>${ev.rating||0}</td>`;
      histBody.appendChild(tr);
    } else {
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${ev.title}</td><td>${ev.orderInfo?.type||ev.type||'-'}</td><td>Pending</td>
      <td><button onclick="openAdminPopup('${ev.id}')">More Info</button></td>`;
      tbody.appendChild(tr);
    }
  });

  renderSummary();
  renderInvoices();
  renderReports();
  renderCharts();
}

let popupId=null;
function openAdminPopup(id){
  const ev = loadEvents().find(e=>e.id===id); if(!ev) return; popupId=id;
  document.getElementById('eventDetailSummary').innerHTML=`<strong>Name:</strong> ${ev.title}<br><strong>Date:</strong> ${ev.date}<br><strong>Status:</strong> ${ev.completed?'Complete':'Pending'}<br><strong>Details:</strong> ${ev.orderInfo?.details||'-'}`;
  document.getElementById('admin-date').value=ev.date;
  document.getElementById('admin-staff').value=ev.assignedStaff||'';
  document.getElementById('admin-att').value=ev.attendance||0;
  document.getElementById('admin-rate').value=ev.rating||0;
  document.getElementById('orderPopup').style.display='flex';
}

function closePopup(){ document.getElementById('orderPopup').style.display='none'; popupId=null; }

function saveAdminEdits(){
  if(!popupId) return; 
  const events=loadEvents(); 
  const idx=events.findIndex(e=>e.id===popupId);
  if(idx===-1) return;
  const newDate=document.getElementById('admin-date').value;
  if(newDate<'2025-11-01'||newDate>'2025-11-30'){alert('Date must be in Nov 2025.'); return;}
  const conflict=events.some((ev)=>ev.date===newDate && ev.id!==popupId); 
  if(conflict){alert('Date already taken.'); return;}
  events[idx].date=newDate;
  events[idx].assignedStaff=document.getElementById('admin-staff').value||null;
  events[idx].attendance=parseInt(document.getElementById('admin-att').value)||0;
  events[idx].rating=parseInt(document.getElementById('admin-rate').value)||0;
  saveEvents(events); 
  closePopup(); 
  loadTable(); 
  alert('Saved.');
}

function markCompleteAdmin(){ 
  if(!popupId) return; 
  const events=loadEvents(); 
  const idx=events.findIndex(e=>e.id===popupId); 
  if(idx===-1) return;
  events[idx].completed=true; 
  saveEvents(events); 
  generateInvoice(events[idx]);
  closePopup(); 
  loadTable(); 
}

function deleteEventAdmin(){ 
  if(!popupId || !confirm('Delete event?')) return;
  let events=loadEvents(); 
  events=events.filter(e=>e.id!==popupId); 
  saveEvents(events); 
  closePopup(); 
  loadTable(); 
}

function generateInvoice(ev){
  const invoices = loadInvoices();
  const invoiceNum = 'INV-'+Date.now();
  const amount = (ev.attendance||0)*10 + 50; // simple mock pricing
  invoices.push({
    invoiceNum,
    customer:ev.title,
    orderType:ev.orderInfo?.type||ev.type||'-',
    amount,
    status:'Pending',
    orderId:ev.id
  });
  saveInvoices(invoices);
}

function renderInvoices(){
  const invoices = loadInvoices();
  const tbody = document.getElementById('invoiceBody'); 
  tbody.innerHTML='';
  invoices.forEach(inv=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${inv.invoiceNum}</td><td>${inv.customer}</td><td>${inv.orderType}</td><td>$${inv.amount}</td><td>${inv.status}</td>
    <td>${inv.status==='Pending'?`<button onclick="markPaid('${inv.invoiceNum}')">Mark as Paid</button>`:''}</td>`;
    tbody.appendChild(tr);
  });
  renderSummary();
}

function markPaid(invoiceNum){
  const invoices = loadInvoices();
  const idx = invoices.findIndex(i=>i.invoiceNum===invoiceNum); 
  if(idx===-1) return;
  invoices[idx].status='Paid';
  saveInvoices(invoices);
  renderInvoices();
}

loadTable();
</script>
</body>
</html>
