<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<style>
body { font-family: Arial,sans-serif; margin:0; background:#f4f4f9; color:#333; }
header { background:#3b5d5b; color:white; padding:15px; text-align:center; }
nav { display:flex; justify-content:center; background:#ece0d7; padding:10px; gap:12px; }
nav a { text-decoration:none; font-weight:bold; color:#31333e; }
nav a:hover { text-decoration:underline; }
.container { max-width:1000px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:10px; text-align:left; }
th { background:#3b5d5b; color:white; }
button { background:#3b5d5b; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
button:hover { background:#2d4443; }
.metrics { display:flex; gap:20px; margin-bottom:12px; }
.metric { background:#f7f7f7; padding:10px; border-radius:8px; flex:1; text-align:center; }
.popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.popup-content { background:white; padding:20px; border-radius:10px; max-width:520px; width:92%; position:relative; }
.close-btn { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#333; }
label{display:block;margin-top:8px}
input, select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
</style>
</head>
<body>

<header><h1>Admin Dashboard</h1></header>
<nav>
  <a href="homePage.html">Home</a>
  <a href="calendar.html">Calendar</a>
  <a href="#" onclick="logout(event)">Logout</a>
</nav>

<div class="container">
  <div class="metrics" id="summaryMetrics">
    <div class="metric"><strong id="totalEvents">0</strong><div>Total Events</div></div>
    <div class="metric"><strong id="avgAttendance">0</strong><div>Avg Attendance</div></div>
    <div class="metric"><strong id="avgRating">0</strong><div>Avg Rating</div></div>
  </div>

  <table>
    <thead>
      <tr><th>Customer Name</th><th>Order Type</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="adminOrdersBody"></tbody>
  </table>
  <p id="noOrders" style="text-align:center; margin-top:10px; display:none;">No events yet.</p>
</div>

<div class="popup" id="orderPopup">
  <div class="popup-content">
    <span class="close-btn" onclick="closePopup()">&times;</span>
    <h2>Event Details & Management</h2>
    <div id="eventDetailSummary"></div>

    <label for="admin-date">Change Date (future dates only)</label>
    <input type="date" id="admin-date">

    <label for="admin-staff">Assign Staff</label>
    <select id="admin-staff">
      <option value="">- none -</option>
      <option value="staff1">staff1</option>
    </select>

    <label for="admin-att">Attendance</label>
    <input type="number" id="admin-att" min="0">

    <label for="admin-rate">Rating (1-5)</label>
    <input type="number" id="admin-rate" min="1" max="5">

    <div style="text-align:right; margin-top:10px;">
      <button onclick="saveAdminEdits()">Save</button>
      <button onclick="markCompleteAdmin()" style="margin-left:8px;">Mark Complete</button>
      <button onclick="deleteEventAdmin()" style="margin-left:8px; background:#c0392b;">Delete</button>
    </div>
  </div>
</div>

<script>
function getTodayStr(){
  const t = new Date();
  const y = t.getFullYear();
  const m = String(t.getMonth()+1).padStart(2,'0');
  const d = String(t.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function getTomorrowStr(){
  const t = new Date();
  const tomorrow = new Date(t.getFullYear(), t.getMonth(), t.getDate()+1);
  const y = tomorrow.getFullYear();
  const m = String(tomorrow.getMonth()+1).padStart(2,'0');
  const d = String(tomorrow.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

let currentUser = null;
try { currentUser = JSON.parse(localStorage.getItem("currentUser")); } catch(e){currentUser=null;}
if(!currentUser || currentUser.role!=='admin'){ alert('Access denied. Only admin.'); window.location.href='login.html'; }

function logout(e){ e.preventDefault(); localStorage.removeItem('currentUser'); window.location.href='login.html'; }

function loadEvents(){ return JSON.parse(localStorage.getItem('events')||'[]'); }
function saveEvents(arr){ localStorage.setItem('events', JSON.stringify(arr)); }

function renderSummary(){
  const events = loadEvents();
  document.getElementById('totalEvents').textContent = events.length;
  const attArr = events.filter(e=>e.attendance!=null).map(e=>e.attendance);
  document.getElementById('avgAttendance').textContent = attArr.length ? Math.round(attArr.reduce((a,b)=>a+b,0)/attArr.length) : 0;
  const rArr = events.filter(e=>e.rating>0).map(e=>e.rating);
  document.getElementById('avgRating').textContent = rArr.length ? (rArr.reduce((a,b)=>a+b,0)/rArr.length).toFixed(1) : 0;
}

function loadTable(){
  const events = loadEvents();
  const tbody = document.getElementById('adminOrdersBody'); 
  tbody.innerHTML='';
  document.getElementById('noOrders').style.display = events.length ? 'none':'block';
  events.forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ev.title}</td><td>${ev.orderInfo?.type||ev.type||'-'}</td><td>${ev.completed?'Complete':'Pending'}</td>
    <td><button onclick="openAdminPopup('${ev.id}')">More Info</button></td>`;
    tbody.appendChild(tr);
  });
  renderSummary();
}

let popupId=null;
function openAdminPopup(id){
  const ev = loadEvents().find(e=>e.id===id); if(!ev) return; popupId=id;
  document.getElementById('eventDetailSummary').innerHTML=
    `<strong>Name:</strong> ${ev.title}<br>
     <strong>Date:</strong> ${ev.date}<br>
     <strong>Status:</strong> ${ev.completed?'Complete':'Pending'}<br>
     <strong>Details:</strong> ${ev.orderInfo?.details||'-'}`;
  document.getElementById('admin-date').value=ev.date;
  document.getElementById('admin-staff').value=ev.assignedStaff||'';
  document.getElementById('admin-att').value=ev.attendance||0;
  document.getElementById('admin-rate').value=ev.rating||0;
  document.getElementById('orderPopup').style.display='flex';
}

function closePopup(){ document.getElementById('orderPopup').style.display='none'; popupId=null; }

function saveAdminEdits(){
  if(!popupId) return; 
  const events=loadEvents(); 
  const idx=events.findIndex(e=>e.id===popupId);
  if(idx===-1) return;

  const newDate=document.getElementById('admin-date').value;
  const tomorrowStr = getTomorrowStr();
  if(!newDate){
    alert('Please select a date.'); 
    return;
  }
  if(newDate < tomorrowStr){
    alert('Date must be in the future.');
    return;
  }

  const conflict=events.some(ev=>ev.date===newDate && ev.id!==popupId); 
  if(conflict){alert('That date already has an event.'); return;}

  events[idx].date=newDate;
  events[idx].assignedStaff=document.getElementById('admin-staff').value||null;
  events[idx].attendance=parseInt(document.getElementById('admin-att').value)||0;
  events[idx].rating=parseInt(document.getElementById('admin-rate').value)||0;

  saveEvents(events); 
  closePopup(); 
  loadTable(); 
  alert('Saved.');
}

function markCompleteAdmin(){ 
  if(!popupId) return; 
  const events=loadEvents(); 
  const idx=events.findIndex(e=>e.id===popupId); 
  if(idx===-1) return;
  events[idx].completed=true; 
  saveEvents(events); 
  closePopup(); 
  loadTable(); 
}

function deleteEventAdmin(){ 
  if(!popupId || !confirm('Delete event?')) return;
  let events=loadEvents(); 
  events=events.filter(e=>e.id!==popupId); 
  saveEvents(events); 
  closePopup(); 
  loadTable(); 
}

loadTable();
</script>
</body>
</html>
