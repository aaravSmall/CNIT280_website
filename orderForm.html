<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Place an Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f4f9; color:#333; }
    header { background:#3b5d5b; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; }
    nav { display:flex; justify-content:center; background:#ece0d7; padding:10px; gap:12px; }
    nav a { text-decoration:none; font-weight:bold; color:#31333e; }
    .container { max-width:700px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    label { display:block; margin:10px 0 5px; font-weight:bold; }
    input, select, textarea { width:100%; padding:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:6px; }
    button { background:#3b5d5b; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; }
    .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .popup-content{ background:white; padding:18px; border-radius:10px; max-width:600px; width:92%; position:relative; }
    .close-btn { position:absolute; top:8px; right:12px; cursor:pointer; font-size:20px; }
    select.lang { border-radius:6px; padding:4px 6px; border:1px solid #ccc; }

    /* Highlight invalid fields */
    .error {
      border-color: red !important;
      box-shadow: 0 0 3px red;
    }
  </style>
</head>
<body>
  <header>
    <h1 data-i18n="orderTitle">Place an Order</h1>
    <div>
      <label for="langSelectOrder" style="font-size:0.9em;">üåê</label>
      <select id="langSelectOrder" class="lang">
        <option value="en">EN</option>
        <option value="es">ES</option>
        <option value="fr">FR</option>
      </select>
    </div>
  </header>
  <nav id="navBar"></nav>

  <div class="container">
    <form id="orderForm">
      <h2 data-i18n="enterInfo">Enter Information</h2>
      <label for="patient-id" data-i18n="nameLabel">Name:</label>
      <input type="text" id="patient-id" name="patient-id" placeholder="Full name" required />

      <label for="email" data-i18n="emailLabel">Email:</label>
      <input type="email" id="email" name="email" placeholder="you@example.com" required />

      <h2 data-i18n="orderInfo">Order Information</h2>
      <label for="order-type" data-i18n="orderType">Order Type:</label>
      <select id="order-type" required>
        <option value="">-- Select --</option>
        <option value="Event Booking">Event Booking</option>
        <option value="Catering">Catering</option>
        <option value="Equipment Rental">Equipment Rental</option>
      </select>

      <label for="order-details" data-i18n="detailsLabel">Details:</label>
      <textarea id="order-details" rows="4" placeholder="Describe your event" required></textarea>

      <label for="event-date" data-i18n="eventDateLabel">Event Date (future dates only):</label>
      <!-- min will be set dynamically to tomorrow -->
      <input type="date" id="event-date" required />

      <label for="attendance" data-i18n="attendanceLabel">Expected Attendance (optional):</label>
      <input type="number" id="attendance" min="0" placeholder="e.g., 50" />

      <h2 data-i18n="paymentInfo">Payment Information</h2>
      <label for="card-name" data-i18n="cardNameLabel">Name on Card:</label>
      <input type="text" id="card-name" required />
      <label for="card-number" data-i18n="cardNumberLabel">Card Number:</label>
      <input type="password" id="card-number" maxlength="16" placeholder="Enter 16-digit card number" required />
      <label for="expiry" data-i18n="expiryLabel">Expiration Date:</label>
      <input type="month" id="expiry" required />
      <label for="cvv" data-i18n="cvvLabel">CVV:</label>
      <input type="password" id="cvv" maxlength="3" placeholder="CVV" required />

      <button type="submit" data-i18n="submitBtn">Submit Order</button>
    </form>
  </div>

  <!-- Success Popup -->
  <div class="popup" id="successPopup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup('successPopup')">&times;</span>
      <h2 data-i18n="reviewTitle">Order Review</h2>
      <div id="orderSummary"></div>
      <div style="text-align:right; margin-top:12px;">
        <button onclick="confirmOrder()" data-i18n="confirmBtn">Confirm Order</button>
      </div>
    </div>
  </div>

  <!-- Error Popup -->
  <div class="popup" id="errorPopup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup('errorPopup')">&times;</span>
      <h2 data-i18n="errorTitle">Error</h2>
      <p id="errorText"></p>
    </div>
  </div>

  <script>
    // NAV BAR
    (function renderNav(){
      const user = JSON.parse(localStorage.getItem('currentUser')||'null');
      const nav = document.getElementById('navBar');
      if(!user){ nav.innerHTML = `<a href="login.html">Login</a>`; return; }
      let html = `<a href="homePage.html">Home</a> <a href="calendar.html">Calendar</a> `;
      if(user.role === 'customer') html += `<a href="orderForm.html">Place an Order</a> <a href="orderHistory.html">Order History</a>`;
      if(user.role === 'admin') html += `<a href="adminDashboard.html">Admin Dashboard</a>`;
      if(user.role === 'staff') html += `<a href="staffDashboard.html">Staff Dashboard</a>`;
      html += ` <a href="login.html" onclick="logout(event)">Logout</a>`;
      nav.innerHTML = html;
    })();

    function logout(e){ e.preventDefault(); localStorage.removeItem('currentUser'); window.location.href='login.html'; }

    // Only customers can access
    const currentUser = JSON.parse(localStorage.getItem('currentUser')||'null');
    if(!currentUser || currentUser.role !== 'customer'){ alert('Access denied. Customers only.'); window.location.href='login.html'; }

    // small helpers for dates
    function getTodayStr(){
      const t = new Date();
      const y = t.getFullYear();
      const m = String(t.getMonth()+1).padStart(2,'0');
      const d = String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function getTomorrowStr(){
      const t = new Date();
      const tomorrow = new Date(t.getFullYear(), t.getMonth(), t.getDate()+1);
      const y = tomorrow.getFullYear();
      const m = String(tomorrow.getMonth()+1).padStart(2,'0');
      const d = String(tomorrow.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    // i18n translations
    const orderTranslations = {
      en: {
        orderTitle:"Place an Order",
        enterInfo:"Enter Information",
        nameLabel:"Name:",
        emailLabel:"Email:",
        orderInfo:"Order Information",
        orderType:"Order Type:",
        detailsLabel:"Details:",
        eventDateLabel:"Event Date (future dates only):",
        attendanceLabel:"Expected Attendance (optional):",
        paymentInfo:"Payment Information",
        cardNameLabel:"Name on Card:",
        cardNumberLabel:"Card Number:",
        expiryLabel:"Expiration Date:",
        cvvLabel:"CVV:",
        submitBtn:"Submit Order",
        reviewTitle:"Order Review",
        confirmBtn:"Confirm Order",
        errorTitle:"Error",
        errRequired:"Please complete all required fields.",
        errEmail:"Please enter a valid email address.",
        errCVV:"CVV must be 3 digits",
        errCardNumber:"Card number must be exactly 16 digits.",
        errExpiry:"Expiration date must be this month or later.",
        errFutureDate:"Event date must be in the future.",
        errBooked:"That date is already booked. Choose another date.",
        errTaken:"That date was just taken. Choose another date.",
        confirmAlert:"Order confirmed, you should receive an email soon!"
      },
      es: {
        orderTitle:"Realizar un pedido",
        enterInfo:"Ingresar informaci√≥n",
        nameLabel:"Nombre:",
        emailLabel:"Correo electr√≥nico:",
        orderInfo:"Informaci√≥n del pedido",
        orderType:"Tipo de pedido:",
        detailsLabel:"Detalles:",
        eventDateLabel:"Fecha del evento (solo fechas futuras):",
        attendanceLabel:"Asistencia esperada (opcional):",
        paymentInfo:"Informaci√≥n de pago",
        cardNameLabel:"Nombre en la tarjeta:",
        cardNumberLabel:"N√∫mero de tarjeta:",
        expiryLabel:"Fecha de expiraci√≥n:",
        cvvLabel:"CVV:",
        submitBtn:"Enviar pedido",
        reviewTitle:"Revisi√≥n del pedido",
        confirmBtn:"Confirmar pedido",
        errorTitle:"Error",
        errRequired:"Por favor completa todos los campos obligatorios.",
        errEmail:"Por favor ingresa un correo electr√≥nico v√°lido.",
        errCVV:"El CVV debe tener 3 d√≠gitos.",
        errCardNumber:"El n√∫mero de tarjeta debe tener exactamente 16 d√≠gitos.",
        errExpiry:"La fecha de expiraci√≥n debe ser este mes o m√°s adelante.",
        errFutureDate:"La fecha del evento debe ser en el futuro.",
        errBooked:"Esa fecha ya est√° reservada. Elige otra fecha.",
        errTaken:"Esa fecha acaba de ser tomada. Elige otra fecha.",
        confirmAlert:"¬°Pedido confirmado, deber√≠as recibir un correo pronto!"
      },
      fr: {
        orderTitle:"Passer une commande",
        enterInfo:"Saisir les informations",
        nameLabel:"Nom :",
        emailLabel:"E-mail :",
        orderInfo:"Informations sur la commande",
        orderType:"Type de commande :",
        detailsLabel:"D√©tails :",
        eventDateLabel:"Date de l‚Äô√©v√©nement (dates futures uniquement) :",
        attendanceLabel:"Participation pr√©vue (optionnel) :",
        paymentInfo:"Informations de paiement",
        cardNameLabel:"Nom sur la carte :",
        cardNumberLabel:"Num√©ro de carte :",
        expiryLabel:"Date d‚Äôexpiration :",
        cvvLabel:"CVV :",
        submitBtn:"Envoyer la commande",
        reviewTitle:"Revue de commande",
        confirmBtn:"Confirmer la commande",
        errorTitle:"Erreur",
        errRequired:"Veuillez remplir tous les champs obligatoires.",
        errEmail:"Veuillez saisir une adresse e-mail valide.",
        errCVV:"Le CVV doit comporter 3 chiffres.",
        errCardNumber:"Le num√©ro de carte doit comporter exactement 16 chiffres.",
        errExpiry:"La date d‚Äôexpiration doit √™tre ce mois-ci ou plus tard.",
        errFutureDate:"La date de l‚Äô√©v√©nement doit √™tre dans le futur.",
        errBooked:"Cette date est d√©j√† r√©serv√©e. Choisissez une autre date.",
        errTaken:"Cette date vient d‚Äô√™tre prise. Choisissez une autre date.",
        confirmAlert:"Commande confirm√©e, vous devriez recevoir un e-mail bient√¥t !"
      }
    };

    let currentLang = 'en';
    function applyOrderLanguage(lang){
      currentLang = lang;
      const t = orderTranslations[lang] || orderTranslations.en;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(t[key]) el.textContent = t[key];
      });
    }

    document.getElementById('langSelectOrder').addEventListener('change', e=>{
      applyOrderLanguage(e.target.value);
    });

    applyOrderLanguage('en');

    // EVENTS / DATE HELPERS
    function isDateBooked(dateStr){ 
      const ev = JSON.parse(localStorage.getItem('events')||'[]'); 
      return ev.some(e=>e.date===dateStr); 
    }

    // Set min date = tomorrow (future dates only)
    (function setMinFutureDate(){
      const input = document.getElementById('event-date');
      if(!input) return;
      const tomorrowStr = getTomorrowStr();
      input.min = tomorrowStr;
    })();

    // Prevent picking dates that already have events
    (function preventBookedDates(){
      const input = document.getElementById('event-date');
      if(!input) return;
      input.addEventListener('change', () => {
        const chosen = input.value;
        if (!chosen) return;
        if (isDateBooked(chosen)) {
          alert('That date already has an event. Please choose another date.');
          input.value = '';
        }
      });
    })();

    // Helper functions for field-specific errors
    function clearFieldErrors() {
      document.querySelectorAll('.error').forEach(el => {
        el.classList.remove('error');
      });
    }

    function setFieldError(element, message) {
      clearFieldErrors();
      if (element) {
        element.classList.add('error');
        element.focus();
      }
      showError(message);
    }

    // FORM HANDLING
    const form = document.getElementById('orderForm');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const t = orderTranslations[currentLang] || orderTranslations.en;

      clearFieldErrors();

      const nameEl       = document.getElementById('patient-id');
      const emailEl      = document.getElementById('email');
      const typeEl       = document.getElementById('order-type');
      const detailsEl    = document.getElementById('order-details');
      const dateEl       = document.getElementById('event-date');
      const attendanceEl = document.getElementById('attendance');
      const cardNameEl   = document.getElementById('card-name');
      const cardNumberEl = document.getElementById('card-number');
      const expiryEl     = document.getElementById('expiry');
      const cvvEl        = document.getElementById('cvv');

      const name       = nameEl.value.trim();
      const email      = emailEl.value.trim();
      const type       = typeEl.value;
      const details    = detailsEl.value.trim();
      const date       = dateEl.value;
      const attendance = attendanceEl.value || '';
      const cardName   = cardNameEl.value.trim();
      const cardNumber = cardNumberEl.value.trim();
      const expiry     = expiryEl.value;  // format "YYYY-MM"
      const cvv        = cvvEl.value.trim();

      // Required fields (attendance is optional)
      if (!name)       { setFieldError(nameEl, t.errRequired); return; }
      if (!email)      { setFieldError(emailEl, t.errRequired); return; }
      if (!type)       { setFieldError(typeEl, t.errRequired); return; }
      if (!details)    { setFieldError(detailsEl, t.errRequired); return; }
      if (!date)       { setFieldError(dateEl, t.errRequired); return; }
      if (!cardName)   { setFieldError(cardNameEl, t.errRequired); return; }
      if (!cardNumber) { setFieldError(cardNumberEl, t.errRequired); return; }
      if (!expiry)     { setFieldError(expiryEl, t.errRequired); return; }
      if (!cvv)        { setFieldError(cvvEl, t.errRequired); return; }

      // Email format
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        setFieldError(emailEl, t.errEmail);
        return;
      }

      // Card number: exactly 16 digits
      if (!/^\d{16}$/.test(cardNumber)) {
        setFieldError(cardNumberEl, t.errCardNumber);
        return;
      }

      // CVV: exactly 3 digits
      if (!/^\d{3}$/.test(cvv)) {
        setFieldError(cvvEl, t.errCVV);
        return;
      }

      // Expiration date: must be this month or later
      if (expiry) {
        const now = new Date();
        const currentYM =
          now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        if (expiry < currentYM) {
          setFieldError(expiryEl, t.errExpiry);
          return;
        }
      }

      // Event date must be in the future (tomorrow or later)
      const tomorrowStr = getTomorrowStr();
      if (date < tomorrowStr) {
        setFieldError(dateEl, t.errFutureDate);
        return;
      }

      // Date not already booked
      if (isDateBooked(date)) {
        setFieldError(dateEl, t.errBooked);
        return;
      }

      // If we reach here, everything is valid ‚Üí show summary popup
      const summary = `
        <strong>${t.nameLabel}</strong> ${name}<br>
        <strong>${t.emailLabel}</strong> ${email}<br>
        <strong>${t.orderType}</strong> ${type}<br>
        <strong>${t.detailsLabel}</strong> ${details}<br>
        <strong>${t.eventDateLabel}</strong> ${date}<br>
        <strong>${t.attendanceLabel}</strong> ${attendance || '-'}<br>
        <strong>${t.cardNameLabel}</strong> ${cardName}<br>
        <strong>${t.cardNumberLabel}</strong> **** **** **** ${cardNumber.slice(-4)}<br>
      `;
      document.getElementById('orderSummary').innerHTML = summary;
      document.getElementById('successPopup').style.display = 'flex';
    });

    function showError(msg){ 
      document.getElementById('errorText').textContent = msg; 
      document.getElementById('errorPopup').style.display = 'flex'; 
    }
    function closePopup(id){ document.getElementById(id).style.display = 'none'; }

    function confirmOrder(){
      const t = orderTranslations[currentLang] || orderTranslations.en;
      const orders = JSON.parse(localStorage.getItem('orders')||'[]');
      const events = JSON.parse(localStorage.getItem('events')||'[]');

      const name = document.getElementById('patient-id').value.trim();
      const email = document.getElementById('email').value.trim();
      const type = document.getElementById('order-type').value;
      const details = document.getElementById('order-details').value.trim();
      const date = document.getElementById('event-date').value;
      const attendance = parseInt(document.getElementById('attendance').value) || 0;
      const cardName = document.getElementById('card-name').value.trim();
      const cardNumber = document.getElementById('card-number').value.trim();
      const expiry = document.getElementById('expiry').value;
      const cvv = document.getElementById('cvv').value.trim();

      // Final double-book check
      if(events.some(e=>e.date===date)){
        closePopup('successPopup');
        showError(t.errTaken);
        return;
      }

      const orderObj = {
        customer: currentUser.username,
        name, email, type, details, date,
        attendance: attendance || 0,
        rating: 0,
        cardName, cardNumber, expiry, cvv,
        status: 'Pending'
      };
      const orderIndex = orders.length;
      orders.push(orderObj);

      const eventObj = {
        id: String(Date.now()),
        title: name,
        date,
        completed: false,
        attendance: attendance || 0,
        rating: 0,
        assignedStaff: null,
        orderIndex,
        orderInfo: orderObj
      };
      events.push(eventObj);

      localStorage.setItem('orders', JSON.stringify(orders));
      localStorage.setItem('events', JSON.stringify(events));

      closePopup('successPopup');
      alert(t.confirmAlert);
      window.location.href = 'orderHistory.html';
    }
  </script>
</body>
</html>
