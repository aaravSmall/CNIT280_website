<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Place an Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f4f9; color:#333; }
    header { background:#3b5d5b; color:white; padding:15px; text-align:center; }
    nav { display:flex; justify-content:center; background:#ece0d7; padding:10px; gap:12px; }
    nav a { text-decoration:none; font-weight:bold; color:#31333e; }
    .container { max-width:700px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    label { display:block; margin:10px 0 5px; font-weight:bold; }
    input, select, textarea { width:100%; padding:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:6px; }
    input.error, textarea.error, select.error { border:2px solid red; }
    .note { font-size:0.9em; color:#666; }
    button { background:#3b5d5b; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; }
    .popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .popup-content{ background:white; padding:18px; border-radius:10px; max-width:600px; width:92%; position:relative; }
    .close-btn { position:absolute; top:8px; right:12px; cursor:pointer; font-size:20px; }
  </style>
</head>
<body>
  <header><h1>Place an Order</h1></header>
  <nav id="navBar"></nav>

  <div class="container">
    <form id="orderForm">
      <h2>Enter Information</h2>
      <label for="patient-id">Name:</label>
      <input type="text" id="patient-id" name="patient-id" placeholder="Full name" required />

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" placeholder="you@example.com" required />

      <h2>Order Information</h2>
      <label for="order-type">Order Type:</label>
      <select id="order-type" required>
        <option value="">-- Select --</option>
        <option>Event Booking</option>
        <option>Catering</option>
        <option>Equipment Rental</option>
      </select>

      <label for="order-details">Details:</label>
      <textarea id="order-details" rows="4" placeholder="Describe your event" required></textarea>

      <label for="event-date">Event Date (Nov 1â€“30, 2025):</label>
      <input type="date" id="event-date" min="2025-11-01" max="2025-11-30" required />

      <label for="attendance">Expected Attendance (optional):</label>
      <input type="number" id="attendance" min="0" placeholder="e.g., 50" />

      <h2>Payment Information</h2>
      <label for="card-name">Name on Card:</label>
      <input type="text" id="card-name" required />
      <label for="card-number">Card Number:</label>
      <input type="password" id="card-number" maxlength="16" placeholder="Enter 16-digit card number" required />
      <label for="expiry">Expiration Date:</label>
      <input type="month" id="expiry" required />
      <label for="cvv">CVV:</label>
      <input type="password" id="cvv" maxlength="3" placeholder="CVV" required />

      <button type="submit">Submit Order</button>
    </form>
  </div>

  <!-- Success Popup -->
  <div class="popup" id="successPopup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup('successPopup')">&times;</span>
      <h2>Order Review</h2>
      <div id="orderSummary"></div>
      <div style="text-align:right; margin-top:12px;">
        <button onclick="confirmOrder()">Confirm Order</button>
      </div>
    </div>
  </div>

  <!-- Error Popup -->
  <div class="popup" id="errorPopup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup('errorPopup')">&times;</span>
      <h2>Error</h2>
      <p id="errorText"></p>
    </div>
  </div>

  <script>
    // Render nav according to role
    (function renderNav(){
      const user = JSON.parse(localStorage.getItem('currentUser')||'null');
      const nav = document.getElementById('navBar');
      if(!user){ nav.innerHTML = `<a href="login.html">Login</a>`; return; }
      let html = `<a href="homePage.html">Home</a> <a href="calendar.html">Calendar</a> `;
      if(user.role === 'customer') html += `<a href="orderForm.html">Place an Order</a> <a href="orderHistory.html">Order History</a>`;
      if(user.role === 'admin') html += `<a href="adminDashboard.html">Admin Dashboard</a>`;
      if(user.role === 'staff') html += `<a href="staffDashboard.html">Staff Dashboard</a>`;
      html += ` <a href="login.html" onclick="logout(event)">Logout</a>`;
      nav.innerHTML = html;
    })();

    function logout(e){ e.preventDefault(); localStorage.removeItem('currentUser'); window.location.href='login.html'; }

    // Only customers can access
    const currentUser = JSON.parse(localStorage.getItem('currentUser')||'null');
    if(!currentUser || currentUser.role !== 'customer'){ alert('Access denied. Customers only.'); window.location.href='login.html'; }

    function isDateBooked(dateStr){ const ev = JSON.parse(localStorage.getItem('events')||'[]'); return ev.some(e=>e.date===dateStr); }

    const form = document.getElementById('orderForm');
    form.addEventListener('submit', e => {
      e.preventDefault();

      // collect values
      const name = document.getElementById('patient-id').value.trim();
      const email = document.getElementById('email').value.trim();
      const type = document.getElementById('order-type').value;
      const details = document.getElementById('order-details').value.trim();
      const date = document.getElementById('event-date').value;
      const attendance = document.getElementById('attendance').value || '';
      const cardName = document.getElementById('card-name').value.trim();
      const cardNumber = document.getElementById('card-number').value.trim();
      const expiry = document.getElementById('expiry').value;
      const cvv = document.getElementById('cvv').value.trim();

      // validation
      if(!name || !email || !type || !details || !date || !cardName || !cardNumber || !expiry || !cvv){
        showError('Please complete all required fields.');
        return;
      }
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('Please enter a valid email address.'); return; }
      if(!/^\d{3}$/.test(cvv)) { showError('CVV must be 3 digits'); return; }
      if(date < '2025-11-01' || date > '2025-11-30'){ showError('Date must be between Nov 1 and Nov 30, 2025.'); return; }
      if(isDateBooked(date)){ showError('That date is already booked. Choose another date.'); return; }

      // review summary
      const summary = `
        <strong>Name:</strong> ${name}<br>
        <strong>Email:</strong> ${email}<br>
        <strong>Order Type:</strong> ${type}<br>
        <strong>Details:</strong> ${details}<br>
        <strong>Event Date:</strong> ${date}<br>
        <strong>Attendance (optional):</strong> ${attendance || '-'}<br>
        <strong>Card Name:</strong> ${cardName}<br>
        <strong>Card Number:</strong> **** **** **** ${cardNumber.slice(-4)}<br>
      `;
      document.getElementById('orderSummary').innerHTML = summary;
      document.getElementById('successPopup').style.display = 'flex';
    });

    function showError(msg){ document.getElementById('errorText').textContent = msg; document.getElementById('errorPopup').style.display = 'flex'; }
    function closePopup(id){ document.getElementById(id).style.display = 'none'; }

    function confirmOrder(){
      const orders = JSON.parse(localStorage.getItem('orders')||'[]');
      const events = JSON.parse(localStorage.getItem('events')||'[]');

      const name = document.getElementById('patient-id').value.trim();
      const email = document.getElementById('email').value.trim();
      const type = document.getElementById('order-type').value;
      const details = document.getElementById('order-details').value.trim();
      const date = document.getElementById('event-date').value;
      const attendance = parseInt(document.getElementById('attendance').value) || 0;
      const cardName = document.getElementById('card-name').value.trim();
      const cardNumber = document.getElementById('card-number').value.trim();
      const expiry = document.getElementById('expiry').value;
      const cvv = document.getElementById('cvv').value.trim();

      if(events.some(e=>e.date===date)){
        closePopup('successPopup');
        showError('That date was just taken. Choose another date.');
        return;
      }

      const orderObj = {
        customer: currentUser.username,
        name, email, type, details, date,
        attendance: attendance || 0,
        rating: 0,
        cardName, cardNumber, expiry, cvv,
        status: 'Pending'
      };
      const orderIndex = orders.length;
      orders.push(orderObj);

      const eventObj = {
        id: String(Date.now()),
        title: name,
        date,
        completed: false,
        attendance: attendance || 0,
        rating: 0,
        assignedStaff: null,
        orderIndex,
        orderInfo: orderObj
      };
      events.push(eventObj);

      localStorage.setItem('orders', JSON.stringify(orders));
      localStorage.setItem('events', JSON.stringify(events));

      closePopup('successPopup');
      alert('Order confirmed, you should receive an email soon!');
      window.location.href = 'orderHistory.html';
    }
  </script>
</body>
</html>
